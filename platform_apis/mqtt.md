# AWS IoT and MQTT

Care Daily uses [AWS IoT Core](https://docs.aws.amazon.com/iot/latest/developerguide/what-is-aws-iot.html) service to receive device's data to the cloud and send commands and configuration settings to devices from Care Daily services.
AWS IoT Core allows connection with devices over [MQTT](https://docs.aws.amazon.com/iot/latest/developerguide/mqtt.html) and WebSocket protocols.

A connected IoT device is able to securely publish data to MQTT message broker and subscribe to responses from Care Daily cloud.

## Devices Authentication and Authorization

Care Daily recommends using [X.509 certificates](https://docs.aws.amazon.com/iot/latest/developerguide/x509-client-certs.html) to authenticate device connections to AWS IoT.

A X.509 certificate has an attached [AWS IoT policy](https://docs.aws.amazon.com/iot/latest/developerguide/iot-policies.html),
which specifies how a device can connect to AWS IoT message broker and to which MQTT topics it can publish data and subscribe.
By default the publish and subscribe MQTT topics filer in the policy is set as a combination of the device type specific prefix and the device ID and ended by a wild card: `YourDeviceTypePrefix/DeviceID/*`.
This filter guaranties that the device can publish and subscribe only to own MQTT topics.

In addition Care Daily supports [custom authentication and authorization](https://docs.aws.amazon.com/iot/latest/developerguide/custom-authentication.html).
This method dynamically generates an IoT policy on each device's connection.

## AWS IoT connection settings

IoT device can call a convenient [Get Connection Server API](https://iotapps.docs.apiary.io/#reference/cloud-connectivity/server-instances/get-server) to obtain all required AWS IoT connection information:

* AWS IoT enpoint including host, port, and TLS version.
* Amazon root CA certificate.
* Device's [X.509 certificate and a private key](https://docs.aws.amazon.com/iot/latest/developerguide/x509-client-certs.html) generated by AWS IoT with an attached [AWS IoT policy](https://docs.aws.amazon.com/iot/latest/developerguide/iot-policies.html).
* MQTT Client ID as it is set in the IoT policy, and which is equal to the device ID by default.
* Device's publish and subscribe MQTT topics prefix as it is specified in the IoT policy.
* Quality of Service, which is at least once (QOS1) by default.

The Get Connection Server API requires Basic authentication.
The device's vendor should discuss the authentication mechanism with the Care Daily team before using this API.

## AWS IoT Device SDKs

The [AWS IoT Device SDKs](https://docs.aws.amazon.com/iot/latest/developerguide/iot-connect-devices.html#iot-connect-device-sdks) provide language-specific support for MQTT and WebSocket protocols, which devices use to communicate with AWS IoT.

## MQTT retained messages

Care Daily supports sending commands and configuration settings to devices in [MQTT retained messages](https://docs.aws.amazon.com/iot/latest/developerguide/mqtt.html#mqtt-retain).
This is a convenient way to deliver messages to temporary disconnected devices.
